expressFrontApp.controller("booking-success",["$scope","$http",function(a,b){$rootScope.currentScreen="bookingDone"}]),expressFrontApp.controller("booking",["$scope","$http","$location","$rootScope","translate","$state",function(a,b,c,d,e,f){a.bookingData={passenger:[],contact:{},boardingLocation:null,dropoffLocation:null},a.errors={},a.selected=!1,a.journeyData={},a.IPG={postUrl:"",Data:[]},a.boardingLocations=[],a.dropoffLocations=[],a.mySeatCheck=null;var g=null,h=null,i=null;a.$on("showBooking",function(b,c){$("body").animate({scrollTop:0},"fast"),a.bookingData.passenger=[],a.bookingData.contact={},a.selected=c.selected,g=c.resultIndex,h=c.from,i=c.to,a.journeyData=c.journeyData,a.jDuration=Util.getTimeDifferenceBetween(a.journeyData.departure,a.journeyData.arrival),a.boardingLocations=c.boardingLocations,a.bookingData.boardingLocation=a.boardingLocations[0],a.dropoffLocations=c.dropoffLocations,a.bookingData.dropoffLocation=a.dropoffLocations[0]}),a.tabs=[{title:e.get("Credit/Debit Cards"),url:"tab-credit",type:"credit_card",active:!0}],null==c.host().match("superline")&&(ndb_promo_tab={title:e.get("NDB Credit Cards - 10 % Off"),url:"tab-credit-ndb-promo",type:"ndb_card",active:!1},a.tabs.push(ndb_promo_tab)),a.bookingData.type=a.tabs[0].type,a.onClickTab=function(b){a.bookingData.type=b.type},a.placeBooking=function(){if(a.errors={passenger:!1,contactData:!1},!a.bookingData.passenger||a.bookingData.passenger.length<1)return void(a.errors.passenger=!0);if(""===$.trim(a.bookingData.contact.mobileNo)&&""==$.trim(a.bookingData.contact.nic))return void(a.errors.contactData=!0);if(!a.selected)return a.Global.error.hasError=!0,void(a.Global.error.message=e.get("Unknown error occurred. Please refresh the web page."));a.Global.loading=!0;var c=a.bookingData,j=d.session;b.post("/app/search/placebooking",{fromCity:h,toCity:i,resultIndex:g,bookingData:c,session:j}).success(function(b){if(b.error)a.Global.loading=!1,a.Global.error.hasError=!0,a.Global.error.message=b.error;else if(a.IPG={postUrl:"",Data:[]},"submitForm"==b.IPGtype){var c=b.IPGForm;$(c).appendTo("body").submit()}else"iframeUrl"==b.IPGtype?(d.currentScreen="bookingPay",d.redirectPayUrl=b.IPGForm,f.go("booking-iframe",{})):(a.Global.loading=!1,a.Global.error.hasError=!0,a.Global.error.message=e.get("Error selecting payment option."))}).error(function(){a.Global.loading=!1,a.Global.error.hasError=!0,a.Global.error.message=e.get("Unknown error occurred. Please try again.")})};var j=function(b){a.bookingData.passenger[b]&&(a.bookingData.passenger[b].nic=a.bookingData.contact.nic,a.bookingData.passenger[b].name=a.bookingData.contact.name,a.bookingData.passenger[b].mobileNo=a.bookingData.contact.mobileNo)};a.$watchCollection("bookingData.contact",function(b,c){null!==a.mySeatCheck&&j(a.mySeatCheck)}),a.$watch("mySeatCheck",function(b,c){if(b!==c&&null!==c){var d=c;a.bookingData.passenger[d]&&(a.bookingData.passenger[d].nic="",a.bookingData.passenger[d].name="",a.bookingData.passenger[d].mobileNo="")}null!==b&&j(b)}),a.mySeatCheck=0}]),expressFrontApp.controller("placeBookingRoute",["$scope","$window","$rootScope","$sce","$timeout",function(a,b,c,d,e){function f(){alert("Your transaction is not successful as we didn't receive any payment for the reservation during the allocated period of time. You will be redirected to the initial step. Please try again."),b.history.back()}"bookingPay"!==c.currentScreen&&b.history.back();var g=c.redirectPayUrl;a.iframeUrl=!1,a.iframeUrl=d.trustAsResourceUrl(g),a.Global.loading=!1,a.waitTime=6e5,a.timeoutPromise=e(f,a.waitTime)}]),expressFrontApp.controller("searchBox",["$scope","$http","$location","$rootScope","translate",function(a,b,c,d,e){a.searchFormData={offercode:"",start:"",end:"",date:null},d.currentScreen="search"}]),expressFrontApp.controller("searchList",["$scope","$http","$stateParams","$location","$rootScope","$compile","translate","$state",function(a,b,c,d,e,f,g,h){a.loading=!0,a.tableHeads=[],a.resultView=Util.isMobile()?"mobileSearchResult":"desktopSearchResult",a.schedules=[],a.suggested=!1,e.currentScreen="result",a.seatsLoading=!1,a.searchTerms={getFromId:function(){return c.from},getFromName:function(){return decodeURIComponent(c.fromName)},getToId:function(){return c.to},getToName:function(){return decodeURIComponent(c.toName)},getDate:function(){return c.date?c.date:Util.getSearchDefaultDate()},getOfferCode:function(){return c.offerCode}},a.subSearchFormData={start:{id:a.searchTerms.getFromId(),name:a.searchTerms.getFromName()},end:{id:a.searchTerms.getToId(),name:a.searchTerms.getToName()},date:new Date(a.searchTerms.getDate()),offercode:a.searchTerms.getOfferCode()},$("body").animate({scrollTop:0},"fast"),a.$watchCollection("subSearchFormData",function(b,c){if(b!==c&&b&&b.date!==c.date&&b.start.id>0&&b.end.id>0){var d=a.subSearchFormData.date;h.go("search-result",{fromName:a.subSearchFormData.start.name,toName:a.subSearchFormData.end.name,from:a.subSearchFormData.start.id,to:a.subSearchFormData.end.id,date:d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2),offerCode:a.subSearchFormData.offercode})}},!0);var i=function(){b.post("/app/search/search",{from:a.searchTerms.getFromId(),fromName:a.searchTerms.getFromName(),to:a.searchTerms.getToId(),toName:a.searchTerms.getToName(),date:a.searchTerms.getDate(),offercode:a.searchTerms.getOfferCode()}).success(function(b){a.loading=!1,b&&b.result?(a.schedules=b.result.oneway,e.session=b.session,a.suggested=b.suggested,a.scheduleTimlineMarker()):(a.schedules=[],a.Global.error.hasError=!0,a.Global.error.message=b.error)}).error(function(){a.loading=!1,a.schedules=[]})};a.scheduleTimlineMarker=function(){for(var b=0,c=a.schedules.length;b<c;b++){var d=a.schedules[b],e="",f="",g="";d.sectors[0].fromCityName===d.sectors[0].schedule.actualFromCity&&(e="A"),d.sectors[0].fromCityName!=d.sectors[0].schedule.actualFromCity&&(e="DA"),d.sectors[0].toCityName!=d.sectors[0].schedule.actualToCity&&(e+="AD"),d.sectors[0].toCityName===d.sectors[0].schedule.actualToCity&&(e+="A"),a.schedules[b].timeLineCircles=e,a.schedules[b].timeLineConnectors=f,a.schedules[b].timeLineTexts=g}},i(),a.datesAreEqual=function(a,b){return 0===moment(a).startOf("day").diff(moment(b).startOf("day"))},a.seatLayoutIsVisible=!1;var j;a.toggleSeatLayout=function(b,c,d){var e=d.currentTarget||d.srcElement,g=$(e).closest(".booking-schedule-container");if(a.closeLayout(),!a.seatLayoutIsVisible){a.seatLayoutIsVisible=!0,g.addClass("seats-displayed"),j=a.$new(),j.busSector=b,j.bus=c;var h=f($("#showSeatsTmpl").html()),i=h(j);g.find(".booking-item-container").append(i),$("body").addClass("seatlayout-displayed")}},a.closeLayout=function(){if($(".seats-displayed").removeClass("seats-displayed"),a.seatLayoutIsVisible){var b=$(".seat-info-row");j.$destroy(),b.remove(),a.seatLayoutIsVisible=!1,$(".seatlayout-displayed").removeClass("seatlayout-displayed")}},a.$on("$destroy",function(){a.closeLayout()})}]),expressFrontApp.controller("seatInfoSubCtrl",["$scope","$http","$state","$stateParams","$rootScope","translate",function(a,b,c,d,e,f){a.seatInfo={},a.selected={seats:[],seatNos:[],amount:0,baseMarkups:0,baseDiscount:0,baseTax:0,baseCharges:0,total:0},a.loaded=!1,a.totX=0,a.totY=0,a.isMobile=Util.isMobile(),a.$parent.seatsLoading=!0;var g=a.bus.prices,h=a.busSector.bus.id,i=a.bus.resultIndex,j=a.busSector,k=a.busSector.busRoute,l=k.boardingStops,m=k.dropStops;b.post("/app/search/seatinfo",{boardingLocation:l[0].id,dropoffLocation:m[0].id,busType:a.busSector.bus.busTypeId,scheduleId:a.busSector.scheduleId,session:e.session}).success(function(b){if(b.result){var c=b.result,d=40,e=0,f=0;for(var g in c.seats){var h=c.seats[g],i=h.x*d,j=h.y*d;Util.isMobile()?c.seats[g].style="right: "+j+"px; top: "+i+"px;":c.seats[g].style="left: "+i+"px; top: "+j+"px;",e=h.x>e?h.x:e,f=h.y>f?h.y:f}a.totX=(Util.isMobile()?f+1:e+1)*d,a.totY=(Util.isMobile()?e+1:f+1)*d,a.seatInfo=c.seats,a.loaded=!0}else a.Global.error.hasError=!0,a.Global.error.message=b.error;a.$parent.seatsLoading=!1}).error(function(){a.$parent.seatsLoading=!1}),a.chooseSeat=function(b,c){var d=$(c.target).closest("div");if(b.available===!0&&b.booked!==!0){var e=a.selected.seats.indexOf(b.id);if(e>-1)a.Global.error.hasError=!1,a.selected.seats.splice(e,1),a.selected.seatNos.splice(e,1),a.selected.amount-=parseFloat(g.fare),a.selected.baseMarkups-=parseFloat(g.baseMarkups),a.selected.baseDiscount-=parseFloat(g.baseDiscount),a.selected.baseTax-=parseFloat(g.baseTax),a.selected.baseCharges-=parseFloat(g.baseCharges),a.selected.total-=parseFloat(g.total),d.removeClass("seat-selected");else{if(a.selected.seats.length>8)return a.Global.error.hasError=!0,void(a.Global.error.message=f.get("TooManySeatsSelected"));a.selected.seats.push(b.id),a.selected.seatNos.push(b.number),a.selected.amount+=parseFloat(g.fare),a.selected.baseMarkups+=parseFloat(g.baseMarkups),a.selected.baseDiscount+=parseFloat(g.baseDiscount),a.selected.baseTax+=parseFloat(g.baseTax),a.selected.baseCharges+=parseFloat(g.baseCharges),a.selected.total+=parseFloat(g.total),d.addClass("seat-selected")}a.selected.busId=h}},a.continueBooking=function(){a.selected.seats.length<1?(a.Global.error.hasError=!0,a.Global.error.message=f.get("Please select at least one seat.")):(a.Global.error.hasError=!1,e.$broadcast("showBooking",{selected:a.selected,from:d.from,to:d.to,resultIndex:i,journeyData:{fromName:j.fromCityName,toName:j.toCityName,busPlate:j.bus.plateNumber,busName:j.bus.name,departure:j.departureTime,arrival:j.arrivalTime,travelClass:j.bus.travelClassName},boardingLocations:l,dropoffLocations:m}),e.currentScreen="booking",c.go("search-result",{fromName:d.fromName,toName:d.toName,from:d.from,to:d.to,date:d.date||Util.getSearchDefaultDate(),offerCode:d.offerCode||"",booking:(new Date).getTime().toString()},{notify:!1}))}}]),expressFrontApp.directive("paymentIframe",["$window",function(a){return{restrict:"A",link:function(a,b,c){$(b).find("iframe")}}}]),expressFrontApp.directive("removeSeats",["$compile",function(a){return{link:function(a,b,c){a.close=function(a){a.preventDefault(),a.stopPropagation(),b.closest(".booking-item-details").remove(),$(".seats-displayed").removeClass("seats-displayed"),$(".seatlayout-displayed").removeClass("seatlayout-displayed")}}}}]),expressFrontApp.directive("scrollStart",["$compile","$window",function(a,b){return{link:function(a,c,d){angular.element(b).bind("scroll",function(){this.pageYOffset>=50?c.addClass("scrolling"):c.removeClass("scrolling")}),angular.element(b).trigger("scroll")}}}]),expressFrontApp.directive("searchDatepicker",["$compile","$animate",function(a,b){return{restrict:"EA",replace:!0,template:'<input type="text"datepicker-options="dateOptions"uib-datepicker-popup="yyyy-MM-dd"ng-click="isOpened=!isOpened"readonly="readonly"min-date="minDate"max-date="maxDate"is-open="isOpened"show-button-bar="false"/>',controller:["$scope","$element",function(a,b){var c=new Date;a.minDate=c,a.maxDate=(new Date).setMonth(c.getMonth()+2),a.dateOptions={showWeeks:"false"}}],link:function(a,b,c){}}}]),expressFrontApp.directive("searchForm",["$compile","$animate",function(a,b){return{restrict:"A",scope:{fromCity:"=searchFromCity",toCity:"=searchToCity",date:"=searchDate",offerCode:"=offerCode"},controller:["$scope","$element","$state","$rootScope","translate",function(a,b,c,d,e){a.submitSearch=function(){if(!a.fromCity||!a.toCity||!a.date)return d.Global.error.hasError=!0,void(d.Global.error.message=e.get("FromToMandatory"));var b=angular.isDefined(a.fromCity.id)?a.fromCity.id:0,f=angular.isDefined(a.fromCity.name)?a.fromCity.name:a.fromCity,g=angular.isDefined(a.toCity.id)?a.toCity.id:0,h=angular.isDefined(a.toCity.name)?a.toCity.name:a.toCity,i=a.date,j=i.getFullYear()+"-"+("0"+(i.getMonth()+1)).slice(-2)+"-"+("0"+i.getDate()).slice(-2);c.go("search-result",{fromName:encodeURIComponent(f),toName:encodeURIComponent(h),from:b,to:g,date:j,offerCode:a.offerCode})}}],link:function(a,b,c){b.on("submit",function(b){b.preventDefault(),b.stopPropagation(),a.submitSearch()})}}}]),expressFrontApp.directive("showSeats",["$compile","$animate",function(a,b){return{link:function(a,b,c){}}}]),expressFrontApp.run(["$templateCache",function(a){a.put("tmplSuggestCityHead",'<a class="city-suggestion-head"><span ng-bind-html="match.label | uibTypeaheadHighlight:query"></span><small ng-show="match.model.nameSi">{{match.model.nameSi}}</small><small ng-show="match.model.nameTa"> | {{match.model.nameTa}}</small></a>'),a.put("tmplSuggestCityPopup",'<div class="custom-popup-wrapper city-suggestion-popup"ng-style="{top: position().top+\'px\', left: position().left+\'px\'}"style="display: block;"ng-show="isOpen() && !moveInProgress"ng-class="{\'open\': (isOpen() && !moveInProgress)}" aria-hidden="{{!isOpen()}}"><ul class="dropdown-menu" role="listbox"><li ng-repeat="match in matches track by $index" ng-class="{active: isActive($index) }"ng-mouseenter="selectActive($index)" ng-click="selectMatch($index)" role="option" id="{{::match.id}}">    <div uib-typeahead-match index="$index" match="match" query="query" template-url="templateUrl"></div>    </li>    </ul></div>')}]).directive("suggestCityBox",["$window","$animate",function(a,b){return{restrict:"EA",replace:!0,scope:{loadingTypehead:"=suggestLoading",dependantCity:"=dependant",bindModel:"="},template:'<input type="text"ng-model="bindModel" autocomplete="off" uib-typeahead="city.name for city in getSuggestions($viewValue)"typeahead-loading="loadingTypehead" typeahead-template-url="tmplSuggestCityHead" typeahead-popup-template-url="tmplSuggestCityPopup" typeahead-on-select="onSelect($item, $model, $label)" />',controller:["$scope","$element","suggestionService","$timeout","$rootScope","translate",function(a,b,c,d,e,f){function g(a){return a.error?void d.cancel(i):a}function h(){d.cancel(i)}var i=null;a.onSelect=function(b,c,d){a.bindModel=b},a.getSuggestions=function(b){return d.cancel(i),b&&b.length<2?{}:i=d(function(){if(a.dependantCity){var d=angular.isDefined(a.dependantCity.id)?a.dependantCity.id:0,e=angular.isDefined(a.dependantCity.name)?a.dependantCity.name:a.dependantCity,f=d>0?d:!!(angular.isString(e)&&e.length>0)&&e;if(f!==!1)return c.getDestination(f,b).then(g,h)}return c.getCity(b).then(g,h)},500)}}],link:function(b,c,d){b.$watch(d.ngModel,function(a){a&&(c[0].value=a&&a.name?a.name:a)}),c.on("click",function(){a.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}}]),expressFrontApp.directive("waitingList",["$compile","$animate",function(a,b){return{restrict:"EA",replace:!0,transclude:!0,template:'<button type="button" ng-click="openPopup()" ng-transclude></button>',scope:{scheduleId:"=",scheduleName:"="},controller:["$scope","$uibModal",function(a,b){a.openPopup=function(){var c=b.open({animation:!0,templateUrl:"/app/index/loadpartial?p=popup-waitinglist",controller:["$scope","$uibModalInstance","items","$http",function(b,c,d,e){b.response={loading:!1,error:!1,success:!1},b.data={seats:1},b.scheduleName=a.scheduleName,b.submit=function(){b.response={loading:!1,error:!1,success:!1},b.response.loading=!0,b.data.scid=d.scheduleId,e.post("/app/search/waitinglist",b.data).then(function(a){a&&a.data.success?b.response.success=!0:b.response.error=!0,b.response.loading=!1},function(a){b.response.loading=!1,b.response.error=!0})},b.close=function(){c.dismiss("cancel")}}],appendTo:"body",windowClass:"popup fullscreen-popup",resolve:{items:function(){return{scheduleId:a.scheduleId,scheduleName:a.scheduleName}}}});c.result.then(function(a){},function(){})}}],link:function(a,b,c){}}}]),$(function(){function a(){var a=$("#tagline ul li.active");a.removeClass("active").addClass("vs-out"),setTimeout(function(){a.removeClass("vs-out")},500);var b=a.next("li");b.length||(b=$("#tagline ul li").first()),b.addClass("active")}setInterval(a,2500),$("#tagline ul li")}),expressFrontApp.config(["$locationProvider","$stateProvider","$urlRouterProvider",function(a,b,c){b.state("home",{url:"/",templateUrl:"/app/index/loadpartial?p=booking",controller:"searchBox"}).state("search-result",{url:"/bus/search/:fromName/:toName/:from/:to/:date/:booking?offerCode",params:{date:{value:null,squash:!0},booking:{value:null,squash:!0}},templateUrl:"/app/index/loadpartial?p=booking",controller:"searchList"}).state("booking-iframe",{url:"/bus/placebooking",templateUrl:"/app/index/loadpartial?p=pay-iframe",controller:"placeBookingRoute"}).state("otherwise",{url:"/"}),c.otherwise("/"),a.html5Mode(!0)}]),expressFrontApp.service("cityDestinationService",["$http","$q","INJECTED_CITY_LIST",function(a,b,c){function d(b){var c=a.post("/app/search/getdestinations",{cityId:b});return c.then(g,f)}function e(){return b.when(c)}function f(a){return angular.isObject(a.data)&&a.data.message?b.reject(a.data.message):b.reject("An unknown error occurred.")}function g(a){return a.data.hasOwnProperty("error"),a.data}return{getDestinationForCity:d,getCityList:e}}]),expressFrontApp.service("suggestionService",["$http","$q",function(a,b){function c(b){var c=a.post("/app/search/getcitysuggestion",{term:b,type:"city"});return c.then(f,e)}function d(b,c){var d=a.post("/app/search/getcitysuggestion",{term:c,origin:b,type:"dest"});return d.then(f,e)}function e(a){return angular.isObject(a.data)&&a.data.message?b.reject(a.data.message):b.reject("An unknown error occurred.")}function f(a){return a.data.hasOwnProperty("error"),a.data}return{getCity:c,getDestination:d}}]);