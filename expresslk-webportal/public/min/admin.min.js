var expressAdminApp=angular.module("expressAdmin",["expressCore","expressCoreConfirm","pascalprecht.translate","uiGmapgoogle-maps","ngTable"]),Entities=Entities?Entities:{};Entities.Name={amenity:"amenity",agent:"agent",booking:"booking",bookingItem:"bookingItem",bookingItemCharge:"bookingItemCharge",bookingItemMarkup:"bookingItemMarkup",bookingItemDiscount:"bookingItemDiscount",bookingItemTax:"bookingItemTax",bookingItemPassenger:"bookingItemPassenger",bookingStatus:"bookingStatus",bus:"bus",busImage:"busImage",busBusRoute:"busBusRoute",busRoute:"busRoute",busStop:"busStop",busType:"busType",busSchedule:"busSchedule",busScheduleBusStop:"busScheduleBusStop",cancellationCharge:"cancellationCharge",change:"change",changeType:"changeType",city:"city",client:"client",conductor:"conductor",driver:"driver",district:"district",operationalSchedule:"operationalSchedule",passenger:"passenger",payment:"payment",person:"person",address:"address",email:"email",telephone:"telephone",refund:"refund",rule:"rule",supplierGroup:"supplierGroup",supplierContactPerson:"supplierContactPerson",supplierAccount:"supplierAccount",supplier:"supplier",travelClass:"travelClass",seatingProfile:"seatingProfile",allowedDivisions:"allowedDivisions",user:"user",module:"module",permission:"permission",permissionGroup:"permissionGroup",permissionSingle:"permissionSingle",accountStatus:"accountStatus",userGroup:"userGroup",division:"division"};var Fragment=Fragment?Fragment:{};Fragment.Name={ticketBox:"TicketBox",reportsView:"ReportsView",alertConductor:"AlertConductor",printSeat:"printSeat",ticketBoxHistory:"TicketBoxHistory",expressInvoiceReport:"ExpressInvoiceReport",approvedRefundReport:"ApprovedRefundReport",futureReservationReport:"FutureReservationReport",dailyCashReconciliation:"DailyCashReconciliation",cashReconciliation:"CashReconciliation",operatedBusFare:"OperatedBusFare",operatedBusFee:"OperatedBusFee",ticketCounterReconciliation:"TicketCounterReconciliation",depoOperatedBusFare:"DepoOperatedBusFare",payMethodCash:"payMethodCash",payMethodCard:"payMethodCard",payMethodMCash:"payMethodMCash",payMethodEzCash:"payMethodEzCash",payMethodBankTransfer:"payMethodBankTransfer",payMethodCashBBK:"payMethodCashBBK",payMethodCardBBK:"payMethodCardBBK",payMethodMCashBBK:"payMethodMCashBBK",payMethodEzCashBBK:"payMethodEzCashBBK",payMethodPayPalBBK:"payMethodPayPalBBK",payMethodBankTransferBBK:"payMethodBankTransferBBK",payMethodVoucherBBK:"payMethodBankVoucherBBK",payMethodPayLater:"payMethodPayLater",payMethodAgent:"payMethodAgent",payMethodPayAtBus:"payMethodPayAtBus",payMethodAgentBBK:"payMethodAgentBBK",dashboard:"Dashboard",operations:"Operations",issueTickets:"issueTickets",recentTickets:"recentTickets",bookingListing:"bookingListing",bookingCancel:"bookingCancel",busListing:"busListing",busLocation:"busLocation",managePerson:"managePerson",manageConductor:"manageConductor",manageDriver:"manageDriver",bookingAagent:"bookingAagent",amenities:"Amenities",manageSupplier:"manageSupplier",manageAccount:"manageAccount",contactPersonal:"contactPersonal",scheduleList:"scheduleList",scheduleAdd:"scheduleAdd",manageUser:"manageUser",manageRole:"manageRole",manageSinglePermission:"manageSinglePermission",manageGroupPermission:"manageGroupPermission",operationReport:"operationReport",performanceReport:"performanceReport",manageCity:"manageCity",manageStop:"manageStop",manageRoute:"manageRoute"};var PermissionGroup=PermissionGroup?PermissionGroup:{};PermissionGroup.Name={legacyBookings:"LEGBK",legacyTicketbox:"LEGTB",users:"USER"},angular.module("expressAdmin").config(["$translateProvider","TRANSLATIONS",function(a,b){a.translations("cl",b),a.preferredLanguage("cl")}]),expressAdminApp.controller("adminCommon",["$scope","$timeout","$rootScope",function(a,b,c){a.Global={error:{hasError:!1,message:""},success:{isSuccess:!1,message:""}},c.Global={error:{hasError:!1,message:""},success:{isSuccess:!1,message:""}},a._showPreLoader=!1;var d,e=function(d,e){d===!0&&b(function(){a.Global.error.hasError=!1,a.Global.error.message="",c.Global.error.hasError=!1,c.Global.error.message=""},1e4)};a.$watch("Global.error.hasError",e),c.$watch("Global.error.hasError",function(b,d){b===!0&&(a.Global.error.hasError=!0,a.Global.error.message=c.Global.error.message)});var f=function(d,e){d===!0&&b(function(){a.Global.success.isSuccess=!1,a.Global.success.message="",c.Global.success.isSuccess=!1,c.Global.success.message=""},1e4)};a.$watch("Global.success.isSuccess",f),c.$watch("Global.success.isSuccess",function(b,d){b===!0&&(a.Global.success.isSuccess=!0,a.Global.success.message=c.Global.success.message)});var g=function(c,e){c===!0?(d&&b.cancel(d),a._showPreLoader=!0):d=b(function(){a._showPreLoader=!1},100)};a.$watch("Global.loading",g),c.$watch("Global.loading",g),c.$on("$routeChangeStart",function(){}),c.$on("$routeChangeSuccess",function(){}),c.$on("$routeChangeError",function(){})}]),expressAdminApp.directive("alertEmail",["$window",function(a){return{restrict:"E",scope:!1,template:'<button type="button" class="btn btn-warning" ng-click="resendEmail()">Re-send Email</button>',controller:["$scope","$element","bookingService","$rootScope",function(a,b,c,d){a.resendEmail=function(){confirm("Are you sure to re-send the Email?")&&(d.Global.loading=!0,c.resedEmail(a.reference).then(function(a){a.error?(d.Global.loading=!1,d.Global.error.hasError=!0,d.Global.error.message=a.error):(d.Global.loading=!1,d.Global.success.isSuccess=!0,d.Global.success.message="Booking Email sent to '"+a.email+"' successfully.")},function(a){d.Global.loading=!1,d.Global.error.hasError=!0,d.Global.error.message=a}))}}],link:function(a,b,c){a.reference=a.$eval(c.bookingReference)}}}]),expressAdminApp.directive("alertSms",["$window",function(a){return{restrict:"E",scope:!1,template:'<button type="button" class="btn btn-warning" ng-click="resendSms()">Re-send SMS</button>',controller:["$scope","$element","bookingService","$rootScope",function(a,b,c,d){a.resendSms=function(){confirm("Are you sure to re-send the SMS?")&&(d.Global.loading=!0,c.resedSms(a.reference).then(function(a){a.error?(d.Global.loading=!1,d.Global.error.hasError=!0,d.Global.error.message=a.error):(d.Global.loading=!1,d.Global.success.isSuccess=!0,d.Global.success.message="Booking SMS sent to '"+a.phone+"' successfully.")},function(a){d.Global.loading=!1,d.Global.error.hasError=!0,d.Global.error.message=a}))}}],link:function(a,b,c){a.reference=a.$eval(c.bookingReference)}}}]),expressAdminApp.directive("expDatepicker",["$window",function(a){return{restrict:"E",scope:!1,template:"",controller:["$scope","$element","bookingService","$rootScope",function(a,b,c,d){a.resendEmail=function(){}}],link:function(a,b,c){a.reference=a.$eval(c.bookingReference)}}}]),expressAdminApp.filter("split",function(){return function(a,b,c){var d=a.split(b);return d[c]?d[c]:null}}),expressAdminApp.config(["$stateProvider",function(a){a.state("legacyTB",{parent:"main",url:"/legacy/ticketbox",controller:["$window",function(a){a.location.href="/legacy/ticketbox"}]})}]),expressAdminApp.service("bookingService",["$http","$q",function(a,b){function c(b){var c=a.post("/admin-panel/ticketbox-ajax/resendsms",{reference:b});return c.then(f,e)}function d(b){var c=a.post("/admin-panel/ticketbox-ajax/resendemail",{reference:b});return c.then(f,e)}function e(a){return angular.isObject(a.data)&&a.data.error?b.reject(a.data.error):b.reject("An unknown error occurred.")}function f(a){return a.data}return{resedSms:c,resedEmail:d}}]),expressAdminApp.service("busesService",["$http","$q",function(a,b){function c(b){var c=a.post("/admin-panel/bus-service/bus",{idBus:b});return c.then(e,d)}function d(a){return angular.isObject(a.data)&&a.data.error?b.reject(a.data.error):b.reject("An unknown error occurred. Please try again")}function e(a){return a.data}return{getBus:c}}]),expressAdminApp.service("scheduleService",["$http","$q",function(a,b){function c(b){var c=a.post("/admin-panel/bus-service/createschedule",b);return c.then(g,f)}function d(b){var c=a.post("/admin-panel/bus-service/schedulelist",{scheduleId:b});return c.then(g,f)}function e(b,c){var d=a.post("/admin-panel/bus-service/setschedulestage",{scheduleId:b,stageCode:c});return d.then(g,f)}function f(a){return angular.isObject(a.data)&&a.data.error?b.reject(a.data.error):b.reject("An unknown error occurred.")}function g(a){return a.data}return{createSchedule:c,getSchedules:d,setStage:e}}]),expressAdminApp.controller("meCollection",["$scope","$window","$filter","meReportService",function(a,b,c,d){a.form={from:new Date,to:moment().add(2,"months").toDate()},a.collection=[],a.total=0,a.total_res_fee=0,a.total_bus_fare=0,a.updateTime=function(){temp=new Date,a.form.from.setHours(temp.getHours()),a.form.from.setMinutes(temp.getMinutes()),a.form.to.setHours(temp.getHours()),a.form.to.setMinutes(temp.getMinutes()),a.collection=[],a.total=0,a.total_res_fee=0,a.total_bus_fare=0},a.loadCollection=function(){a.loading=!0,d.getCollection(a.form.from,a.form.to).then(function(b){if(b.error)a.Global.error.hasError=!0,a.Global.error.message=b.error;else{a.total=0,a.collection=b.collection;for(var c in a.collection){var d=parseFloat(a.collection[c].totalPaid);isNaN(d)||(a.total+=d);var e=parseFloat(a.collection[c].fare);isNaN(e)||(a.total_bus_fare+=e);var f=parseFloat(a.collection[c].totalPaid)-parseFloat(a.collection[c].fare);isNaN(f)||(a.total_res_fee+=f)}}a.loading=!1},function(b){a.Global.error.hasError=!0,a.Global.error.message=b,a.loading=!1})},a.printRpt=function(d){var e=960,f=500;return b.open("/admin-panel/me/collectionprint?from="+c("date")(a.form.from,"yyyy-MM-dd")+"&to="+c("date")(a.form.to,"yyyy-MM-dd"),"Collection Report","status=no,width="+e+",height="+f+",top="+(screen.height/2-f/2)+",left="+(screen.width/2-e/2)+",toolbar=no,menubar=no,scrollbars=no,location=no"),!1},a.loadCollection()}]),expressAdminApp.config(["$stateProvider",function(a){a.state("me-index",{parent:"main",url:"/me",templateUrl:"/admin-panel/me/"}).state("me-collection",{parent:"main",url:"/me/collection",templateUrl:"/admin-panel/me/collection"})}]),expressAdminApp.service("meReportService",["$http","$q",function(a,b){function c(b,c){var f=a.post("/admin-panel/me/collectionreport",{from:b,to:c});return f.then(e,d)}function d(a){return angular.isObject(a.data)&&a.data.error?b.reject(a.data.error):b.reject("An unknown error occurred.")}function e(a){return a.data.hasOwnProperty("error"),a.data}return{getCollection:c}}]),angular.module("expressCoreConfirm",["ui.bootstrap.modal"]).controller("expConfirmModalController",["$scope","$uibModalInstance","data",function(a,b,c){a.data=angular.copy(c),a.ok=function(a){b.close(a)},a.cancel=function(a){angular.isUndefined(a)&&(a="cancel"),b.dismiss(a)}}]).value("$expConfirmModalDefaults",{template:'<div class="modal-header"><h3 class="modal-title">{{data.title}}</h3></div><div class="modal-body">{{data.text}}</div><div class="modal-footer"><button class="btn btn-primary" ng-click="ok()">{{data.ok}}</button><button class="btn btn-default" ng-click="cancel()">{{data.cancel}}</button></div>',controller:"expConfirmModalController",defaultLabels:{title:"Confirm",ok:"OK",cancel:"Cancel"},backdrop:"static",keyboard:!1,additionalTemplates:{}}).factory("$expConfirm",["$uibModal","$expConfirmModalDefaults",function(a,b){return function(c,d){var e=angular.copy(b);if(d=angular.extend(e,d||{}),c=angular.extend({},d.defaultLabels,c||{}),c.templateName){var f=d.additionalTemplates[c.templateName];void 0!=f&&(d.template=f.template,d.templateUrl=f.templateUrl)}return"templateUrl"in d&&"template"in d&&delete d.template,d.resolve={data:function(){return c}},a.open(d).result}}]).directive("expConfirm",["$expConfirm","$timeout",function(a,b){return{priority:1,restrict:"A",scope:{confirmIf:"=",ngClick:"&",confirm:"@",confirmSettings:"=",confirmTemplateName:"@",confirmTitle:"@",confirmOk:"@",confirmCancel:"@"},link:function(c,d,e){function f(){var a=d[0];if(["checkbox","radio"].indexOf(a.type)!=-1){var b=d.data("$ngModelController");b?(b.$setViewValue(!a.checked),b.$render()):a.checked=!a.checked}c.ngClick()}d.unbind("click").bind("click",function(d){d.preventDefault(),b(function(){if(angular.isUndefined(c.confirmIf)||c.confirmIf){var b={text:c.confirm};c.confirmTitle&&(b.title=c.confirmTitle),c.confirmOk&&(b.ok=c.confirmOk),c.confirmCancel&&(b.cancel=c.confirmCancel),c.confirmTemplateName&&(b.templateName=c.confirmTemplateName),a(b,c.confirmSettings||{}).then(f)}else c.$apply(f)})})}}}]);