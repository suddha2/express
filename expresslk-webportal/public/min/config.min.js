expressAdminApp.controller("addBus",["$scope","$http",function(a,b){a.form={},a.save=function(){b.post("/admin-panel/bus/addbusajax",a.form).success(function(b){b.success?(a.form={},a.Global.success.hasSuccess=!0,a.Global.success.message="Saved successfully"):(a.Global.error.hasError=!0,a.Global.error.message="Save failed. Please try again.")})}}]),expressAdminApp.controller("searchBus",["$scope","ngTableParams","$http","$routeParams",function(a,b,c,d){a.form={},a.tableParams=new b({page:1,count:5},{total:0,getData:function(b,d){c.post("/admin-panel/bus/busresult",a.form).success(function(a){if(a.success){var c=a.success;d.total(a.total),b.resolve(c.slice((d.page()-1)*d.count(),d.page()*d.count()))}})}}),a.search=function(){a.tableParams.reload()}}]),expressAdminApp.controller("addSchedule",["$scope","$http","busesService","scheduleService","$timeout",function(a,b,c,d,e){function f(){if(a.bus.id){var b=!0;for(var c in a.bus.busRoutes){var d=a.bus.busRoutes[c],e=d.busRoute;if(a.routes.hasOwnProperty(e.id)||(a.routes[e.id]={}),a.routes[e.id].hasOwnProperty("startTime")||(a.routes[e.id].startTime=g.hasOwnProperty(e.id)?g[e.id]:new Date),"[object Date]"!==Object.prototype.toString.call(a.routes[e.id].startTime)&&(a.routes[e.id].startTime=new Date),a.routes[e.id].hasOwnProperty("loadFactor")||(a.routes[e.id].loadFactor=d.loadFactor),a.routes[e.id].hasOwnProperty("disabled")||(a.routes[e.id].disabled=!1),g[e.id]=a.routes[e.id].startTime,e.hasOwnProperty("routeStops")){var f={},h=null,i=null;if(a.routes[e.id].hasOwnProperty("busStops"))for(var j in a.routes[e.id].busStops)!function(){var b=a.routes[e.id].busStops[j],c=b.startTime,d=b.endTime;f[j]={},f[j].waitingTime=Util.getTimeDifferenceBetween(c,d),f[j].travelTime=[0,0,0],i&&(f[i].travelTime=Util.getTimeDifferenceBetween(h,c)),i=j,h=d}();var k=null,l=null,m={};for(var n in e.routeStops){var o=e.routeStops[n],p="stop-"+o.id;a.bus.busRoutes[c].busRoute.routeStops[n].itKey=p;var q="string"==typeof o.waitingTime?o.waitingTime.split(":"):[0,0,0],r="string"==typeof o.travelTime?o.travelTime.split(":"):[0,0,0];f.hasOwnProperty(p)&&(q=f[p].waitingTime,r=f[p].travelTime),m[p]={},m[p].stopId=o.stop.id,m[p].index=o.index,l?(m[p].startTime=l,m[p].endTime=moment(m[p].startTime).add(q[0],"hours").add(q[1],"minutes").add(q[2],"seconds").toDate()):(m[p].startTime=moment(a.routes[e.id].startTime).subtract(q[0],"hours").subtract(q[1],"minutes").subtract(q[2],"seconds").toDate(),m[p].endTime=new Date(a.routes[e.id].startTime)),l=moment(m[p].endTime).add(r[0],"hours").add(r[1],"minutes").add(r[2],"seconds").toDate(),k=new Date(m[p].startTime)}a.routes[e.id].busStops=m,a.routes[e.id].endTime=k}}a.recurringIsActive=b,b||(a.recurring=!1)}}var g={};a.routes={},a.bus={},a.bus_plate="",a.bus_id="",a.seatingProfile="",a.seatingProfileList=[],a.min_date=new Date,a.max_date=null,a.recur_from=new Date,a.recur_to=new Date,a.recurring="",a.recurringIsActive=!1,a.alternate_days=!1,a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.$watch("recur_from",function(b,c){if(c!=b)for(var d in a.bus.busRoutes){var e=a.bus.busRoutes[d],f=e.busRoute;a.routes[f.id].startTime=b}}),a.loadBus=function(b,d,e,g){a.bus_id=b.id,a.routes={},a.bus={},a.Global.loading=!0,c.getBus(a.bus_id).then(function(b){if(b.bus){a.bus=b.bus;var c=null;a.bus.permitExpiryDate&&(c=a.bus.permitExpiryDate),a.bus.drivingLicenceExpiryDate&&(!c||c<a.bus.drivingLicenceExpiryDate)&&(c=a.bus.drivingLicenceExpiryDate),a.max_date=c;var d=a.bus.seatingProfile&&a.bus.seatingProfile.id?a.bus.seatingProfile.id:null;for(var e in b.seatingProfiles)b.seatingProfiles[e].id==d&&(a.seatingProfile=b.seatingProfiles[e].id);a.seatingProfileList=b.seatingProfiles,a.recurringIsActive=!0,f()}else a.Global.error.hasError=!0,a.Global.error.message=b.error;a.Global.loading=!1},function(b){a.Global.loading=!1,a.Global.error.hasError=!0,a.Global.error.message=b})},a.reloadStops=function(){f()},a.save=function(){if(!a.recurring||confirm("Recurring date range active. Is it intended?")){var b={busId:a.bus.id,seatingProfile:a.seatingProfile,routes:a.routes,driver:a.bus.driver?a.bus.driver.id:null,conductor:a.bus.conductor?a.bus.conductor.id:null,from:a.recur_from,to:a.recur_to,recurring:a.recurring,alternateDays:a.alternate_days};a.Global.loading=!0,d.createSchedule(b).then(function(b){if(b.success){a.bus_id;a.bus_id="",a.routes={},a.bus={},a.seatingProfile="",a.bus_plate="",a.recurring="",a.recurringIsActive=!1,a.Global.success.isSuccess=!0,a.Global.success.message="Schedule(s) added successfully",e(function(){a.bus_id=""},100)}else{var c=b.error?b.error:"Server error occurred. Please try again.";a.Global.error.hasError=!0,a.Global.error.message=c}a.Global.loading=!1},function(b){a.Global.loading=!1,a.Global.error.hasError=!0,a.Global.error.message=b})}},a.getBusList=function(a){return b.get("/admin-panel/BusSchedule/getBusByPlate?",{params:{plateNumber:a}}).then(function(a){return a.data.map(function(a){return a})})},a.busList=function(a){if(null!=a&&void 0!=a)return""==a.plateNumber||void 0==a.plateNumber?"":a.plateNumber}}]),expressAdminApp.controller("viewSchedule",["$scope","ngTableParams","scheduleService","$filter","$interval",function(a,b,c,d,e){function f(){c.getSchedules().then(function(b){b.result?(g=b.result,a.tableParams&&a.tableParams.reload()):(a.Global.error.hasError=!0,a.Global.error.message=b.error?b.error:"Unknown error occurred.")},function(b){a.Global.loading=!1,a.Global.error.hasError=!0,a.Global.error.message=b})}a.form={};var g=[];a.tableParams=new b({page:1,count:10,sorting:{departureTime:"desc"}},{total:0,getData:function(a,b){g=b.sorting()?d("orderBy")(g,b.orderBy()):g,b.total(g.length),a.resolve(g.slice((b.page()-1)*b.count(),b.page()*b.count()))}}),a.search=function(){a.tableParams.reload()},f(),a.getTrClass=function(a){var b=moment(),c=moment(a.departureTime);return{success:b.startOf("day").isSame(c.startOf("day"))}}}]),expressAdminApp.controller("addUser",["$scope","$http",function(a,b){a.form={},a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.save=function(){b.post("/admin-panel/user/addajax",a.form).success(function(b){b.success?(a.form={},a.Global.success.hasSuccess=!0,a.Global.success.message="Saved successfully"):(a.Global.error.hasError=!0,a.Global.error.message="Save failed. Please try again.")})}}]),expressAdminApp.controller("viewUser",["$scope","ngTableParams","$http",function(a,b,c){a.form={},a.tableParams=new b({page:1,count:10},{total:0,getData:function(b,d){c.post("/admin-panel/user/viewajax",a.form).success(function(a){if(a.success){var c=a.success;d.total(a.total),b.resolve(c.slice((d.page()-1)*d.count(),d.page()*d.count()))}})}}),a.search=function(){a.tableParams.reload()}}]),expressAdminApp.config(["$stateProvider",function(a){a.state("schedules",{parent:"main",url:"/view_schedule",controller:"viewSchedule",templateUrl:"/admin-panel/bus-schedule/view"}).state("addschedules",{parent:"main",url:"/add_schedule",controller:"addSchedule",templateUrl:"/admin-panel/bus-schedule/add"})}]);